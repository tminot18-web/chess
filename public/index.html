<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Live Eval Chess</title>

    <link rel="stylesheet" href="/cm-assets/chessboard.css" />
    <link rel="icon" href="data:," />

    <style>
      :root {
        --bg: #0b0f14;
        --text: #dbe3ee;
        --muted: rgba(219, 227, 238, 0.7);
        --border: rgba(219, 227, 238, 0.12);
        --accent: #7c5cff;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
        --radius: 16px;
      }
      * { box-sizing: border-box; }
      html, body {
        height: 100%;
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background:
          radial-gradient(1200px 700px at 30% 10%, rgba(124, 92, 255, 0.15), transparent 60%),
          radial-gradient(800px 500px at 80% 30%, rgba(40, 209, 124, 0.12), transparent 60%),
          var(--bg);
        color: var(--text);
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px;
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 18px;
      }
      @media (max-width: 980px) { .wrap { grid-template-columns: 1fr; } }

      .card {
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }
      .header {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      .title { font-size: 16px; font-weight: 800; letter-spacing: 0.3px; }
      .pillRow { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
      .pill {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.03);
        color: var(--muted);
      }
      .pill strong { color: var(--text); }

      .boardBody {
        display: grid;
        grid-template-columns: 18px 1fr;
        gap: 12px;
        padding: 14px;
        align-items: stretch;
      }

      .evalBar {
        width: 14px;
        border-radius: 999px;
        background: rgba(255,255,255,0.06);
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05), 0 0 18px rgba(124,92,255,0.18);
      }
      .evalFillWhite {
        position: absolute; bottom: 50%; left: 0; right: 0;
        height: 50%;
        background: linear-gradient(180deg, rgba(219,227,238,0.95), rgba(219,227,238,0.55));
      }
      .evalFillBlack {
        position: absolute; top: 50%; left: 0; right: 0;
        height: 50%;
        background: linear-gradient(180deg, rgba(10,12,14,0.95), rgba(10,12,14,0.55));
      }
      .evalMarker {
        position: absolute; left: 0; right: 0;
        height: 2px; top: calc(50% - 1px);
        background: rgba(124,92,255,0.8);
        filter: drop-shadow(0 0 8px rgba(124,92,255,0.9));
      }

      #board {
        width: 100%;
        max-width: 640px;
        aspect-ratio: 1 / 1;
        margin: 0 auto;
      }

      .rightCol { display: grid; grid-template-rows: auto auto 1fr; gap: 12px; }
      .panelBody { padding: 12px 14px; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

      button, input { font: inherit; }
      button {
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.04);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
      }
      button.primary {
        border-color: rgba(124,92,255,0.45);
        background: rgba(124,92,255,0.18);
      }
      button.danger {
        border-color: rgba(255,77,77,0.45);
        background: rgba(255,77,77,0.12);
      }
      button:disabled { opacity: 0.45; cursor: not-allowed; }

      input[type="text"] {
        flex: 1;
        min-width: 160px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(0,0,0,0.25);
        color: var(--text);
        outline: none;
      }

      .kv { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-top: 10px; }
      .kv .k { color: var(--muted); font-size: 12px; }
      .kv .v { font-weight: 800; font-size: 28px; }

      .modeLine { margin-top: 10px; font-size: 12px; color: var(--muted); }
      .modeLine strong { color: var(--text); }

      .feed {
        height: 340px;
        overflow: auto;
        padding: 10px 12px;
        border-top: 1px solid var(--border);
      }
      .msg {
        margin: 0 0 10px 0;
        padding: 10px 10px;
        border: 1px solid rgba(219,227,238,0.12);
        background: rgba(0,0,0,0.18);
        border-radius: 12px;
      }
      .msg .meta {
        display: flex;
        gap: 8px;
        margin-bottom: 6px;
        color: rgba(219,227,238,0.75);
        font-size: 11px;
      }
      .tag {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(219,227,238,0.15);
        background: rgba(255,255,255,0.03);
      }
      .tag.sys { border-color: rgba(124,92,255,0.25); }
      .tag.user { border-color: rgba(40,209,124,0.25); }
      .tag.err { border-color: rgba(255,77,77,0.35); }
      .msg .text { white-space: pre-wrap; font-size: 13px; line-height: 1.35; }

      .chatRow { display: flex; gap: 8px; padding: 12px 12px 14px 12px; }
    </style>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chess.js@0.10.3/chess.min.js"></script>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <div class="header">
          <div class="title">Live Eval Chess</div>
          <div class="pillRow">
            <div class="pill">room: <strong id="roomPill">—</strong></div>
            <div class="pill">role: <strong id="rolePill">—</strong></div>
            <div class="pill">players: <strong id="playersPill">0</strong></div>
          </div>
        </div>

        <div class="boardBody">
          <div class="evalBar">
            <div class="evalFillWhite" id="evalWhiteFill"></div>
            <div class="evalFillBlack" id="evalBlackFill"></div>
            <div class="evalMarker"></div>
          </div>
          <div id="board"></div>
        </div>
      </div>

      <div class="rightCol">
        <div class="card">
          <div class="header">
            <div class="title">Controls</div>
            <div class="pillRow">
              <div class="pill">engine: <strong id="engineStatus">starting…</strong></div>
            </div>
          </div>

          <div class="panelBody">
            <div class="row">
              <button id="playOnlineBtn" class="primary">Play Online</button>
              <button id="cancelBtn" class="danger" disabled>Cancel</button>
              <button id="restartBtn" disabled>Restart</button>
              <button id="copyBtn" disabled>Copy Link</button>
            </div>

            <div class="kv">
              <div class="k">Eval</div>
              <div class="v" id="evalNum">+0.0</div>
            </div>

            <div class="modeLine">
              mode: <strong id="modeText">idle</strong> • you can only move when it's your turn
            </div>

            <hr style="border:none;border-top:1px solid var(--border);margin:14px 0" />

            <div class="row" style="margin-bottom: 8px">
              <button id="createBtn">Create (Friend Room)</button>
              <input id="joinInput" type="text" placeholder="ROOM CODE" />
              <button id="joinBtn">Join</button>
            </div>

            <div style="color: var(--muted); font-size: 12px">
              Online matchmaking: waits until 2 players are searching. Friend rooms: share link with ?room=CODE.
            </div>
          </div>
        </div>

        <div class="card" style="display:grid;grid-template-rows:auto 1fr auto">
          <div class="header">
            <div class="title">Feed / Chat</div>
            <div class="pillRow"><div class="pill">log</div></div>
          </div>

          <div id="feed" class="feed"></div>

          <div class="chatRow">
            <input id="chatInput" type="text" placeholder="message…" />
            <button id="sendBtn">Send</button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { COLOR, Chessboard, FEN, INPUT_EVENT_TYPE } from "https://unpkg.com/cm-chessboard@8.7.8/src/Chessboard.js";

      // ---------- DOM ----------
      const feedEl = document.getElementById("feed");
      const roomEl = document.getElementById("roomPill");
      const roleEl = document.getElementById("rolePill");
      const playersEl = document.getElementById("playersPill");

      const evalNumEl = document.getElementById("evalNum");
      const evalWhiteFill = document.getElementById("evalWhiteFill");
      const evalBlackFill = document.getElementById("evalBlackFill");
      const engineStatusEl = document.getElementById("engineStatus");
      const modeTextEl = document.getElementById("modeText");

      const playOnlineBtn = document.getElementById("playOnlineBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const restartBtn = document.getElementById("restartBtn");
      const copyBtn = document.getElementById("copyBtn");

      const createBtn = document.getElementById("createBtn");
      const joinBtn = document.getElementById("joinBtn");
      const joinInput = document.getElementById("joinInput");

      const chatInput = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");

      // ---------- Feed helpers ----------
      function addMsg(kind, from, text) {
        const d = document.createElement("div");
        d.className = "msg";
        const meta = document.createElement("div");
        meta.className = "meta";
        const tag = document.createElement("span");
        tag.className = "tag " + (kind === "sys" ? "sys" : kind === "err" ? "err" : "user");
        tag.textContent = kind;
        const who = document.createElement("span");
        who.textContent = from;
        meta.appendChild(tag);
        meta.appendChild(who);

        const body = document.createElement("div");
        body.className = "text";
        body.textContent = text;

        d.appendChild(meta);
        d.appendChild(body);
        feedEl.appendChild(d);
        feedEl.scrollTop = feedEl.scrollHeight;
      }
      const ts = () => new Date().toTimeString().slice(0, 8);
      const sys = (t) => addMsg("sys", ts(), t);
      const err = (t) => addMsg("err", "error", t);

      window.addEventListener("error", (e) => err(e?.message || String(e)));
      window.addEventListener("unhandledrejection", (e) =>
        err("unhandledrejection: " + (e?.reason?.message || String(e.reason)))
      );

      sys("booted");

      // ---------- State ----------
      let currentRoom = null;
      let myRole = null; // "white" | "black"
      let mode = "idle"; // idle | searching | matched
      let engineReady = false;

      function setMode(next) {
        mode = next;
        modeTextEl.textContent = mode;
        const searching = mode === "searching";
        playOnlineBtn.disabled = searching;
        cancelBtn.disabled = !searching;
        restartBtn.disabled = !(mode === "matched");
      }

      function updateTopPills(players = null) {
        roomEl.textContent = currentRoom || "—";
        roleEl.textContent = myRole || "—";
        if (players !== null) playersEl.textContent = String(players);
        copyBtn.disabled = !currentRoom;
      }

      function clearSession() {
        currentRoom = null;
        myRole = null;
        const u = new URL(location.href);
        u.searchParams.delete("room");
        history.replaceState({}, "", u);
        updateTopPills(0);
      }

      // ---------- Board ----------
      const boardEl = document.getElementById("board");
      const board = new Chessboard(boardEl, {
        assetsUrl: "/cm-assets/",
        position: FEN.start,
        orientation: COLOR.white,
        style: { borderType: "thin" },
        sprite: { url: "/cm-assets/pieces/staunty.svg" },
      });
      board.setPosition(FEN.start);

      const game = new Chess();

      function setOrientation() {
        board.setOrientation(myRole === "black" ? COLOR.black : COLOR.white);
      }

      function resetLocalGame() {
        game.reset();
        board.setPosition(game.fen());
        requestEval(game.fen());
      }

      function canMoveNow() {
        const turn = game.turn();
        if (myRole === "white") return turn === "w";
        if (myRole === "black") return turn === "b";
        return false;
      }

      // ---------- Eval bar ----------
      function fmtEval(cp) {
        const v = cp / 100;
        const sign = v > 0 ? "+" : "";
        return sign + v.toFixed(1);
      }

      function setEvalBarFromCp(cp, opts = {}) {
        const label = typeof opts.label === "string" ? opts.label : null;
        const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
        const c = clamp(cp, -600, 600);
        const whitePct = 50 + c / 12;
        const w = clamp(whitePct, 0, 100);
        const b = 100 - w;
        evalWhiteFill.style.width = `${w}%`;
        evalBlackFill.style.width = `${b}%`;
        evalNumEl.textContent = label ? label : fmtEval(cp);
      }
      setEvalBarFromCp(0);

      // ---------- Stockfish (same-origin worker: /stockfish.js) ----------
      let sf = null;
      let evalJob = 0;
      let accepting = false;

      function initStockfish() {
        engineStatusEl.textContent = "starting…";
        try {
          sf = new Worker("/stockfish.js");
        } catch (e) {
          engineStatusEl.textContent = "error";
          err("Stockfish Worker failed to construct: " + (e?.message || e));
          return;
        }

        sf.onmessage = (e) => {
          const line = (e.data || "").toString();

          if (line === "uciok") sf.postMessage("isready");
          if (line === "readyok") {
            engineReady = true;
            engineStatusEl.textContent = "ready";
            sys("engine ready");
            requestEval(game.fen());
            return;
          }

          if (!accepting) return;
          if (line.startsWith("info") && line.includes("score")) {
            const mMate = line.match(/score mate (-?\d+)/);
            if (mMate) {
              const mateN = parseInt(mMate[1], 10);
              const mateText = (mateN > 0 ? "+M" : "-M") + Math.abs(mateN);
              setEvalBarFromCp(mateN > 0 ? 600 : -600, { label: mateText });
              return;
            }
            const mCp = line.match(/score cp (-?\d+)/);
            if (mCp) {
              const cp = parseInt(mCp[1], 10);
              const whitePov = game.turn() === "w" ? cp : -cp;
              setEvalBarFromCp(whitePov);
            }
          }
        };

        sf.onerror = (e) => {
          engineStatusEl.textContent = "error";
          err("Stockfish worker error (see console).");
          console.error("stockfish worker error", e);
        };

        sf.postMessage("uci");
      }

      function requestEval(fen) {
        if (!sf || !engineReady) return;
        evalJob += 1;
        const jobId = evalJob;
        accepting = true;
        setTimeout(() => {
          if (jobId === evalJob) accepting = false;
        }, 2500);

        sf.postMessage("stop");
        sf.postMessage("ucinewgame");
        sf.postMessage("position fen " + fen);
        sf.postMessage("go depth 12");
      }

      initStockfish();

      // ---------- Socket ----------
      const socket = io({ transports: ["polling", "websocket"] });

      socket.on("connect", () => sys("socket connected"));
      socket.on("disconnect", () => sys("socket disconnected"));
      socket.on("connect_error", (e) => {
        err("socket connect_error: " + (e?.message || e));
        console.error("connect_error", e);
      });

      socket.on("queue:status", ({ state }) => {
        if (state === "searching") {
          clearSession();
          setMode("searching");
          sys("searching…");
        } else {
          setMode("idle");
          sys("idle");
        }
      });

      socket.on("match:found", ({ room, role }) => {
        currentRoom = room;
        myRole = role === "w" ? "white" : "black";
        setMode("matched");
        updateTopPills(2);
        setOrientation();
        resetLocalGame();
        const u = new URL(location.href);
        u.searchParams.set("room", currentRoom);
        history.replaceState({}, "", u);
        sys(`match found: ${room} (${myRole})`);
      });

      socket.on("room:created", ({ room }) => {
        currentRoom = room;
        myRole = "white";
        setMode("matched");
        updateTopPills(1);
        setOrientation();
        resetLocalGame();
        const u = new URL(location.href);
        u.searchParams.set("room", currentRoom);
        history.replaceState({}, "", u);
        sys(`room created: ${room}`);
      });

      socket.on("room:joined", ({ room, role, players }) => {
        currentRoom = room;
        myRole = role === "w" ? "white" : "black";
        setMode("matched");
        updateTopPills(players ?? null);
        setOrientation();
        resetLocalGame();
        const u = new URL(location.href);
        u.searchParams.set("room", currentRoom);
        history.replaceState({}, "", u);
        sys(`joined room: ${room} (${myRole})`);
      });

      socket.on("room:update", ({ room, players }) => {
        if (room === currentRoom && typeof players === "number") playersEl.textContent = String(players);
      });

      socket.on("opponent:left", () => sys("opponent left"));

      socket.on("move", ({ fen }) => {
        if (!fen) return;
        game.load(fen);
        board.setPosition(game.fen());
        requestEval(game.fen());
      });

      socket.on("chat", (m) => {
        try {
          if (!m) return;
          if (m.kind === "sys") addMsg("sys", m.at || "sys", m.text || "");
          else if (m.kind === "user") addMsg("user", `${m.at || ""} ${m.from || ""}`.trim(), m.text || "");
          else addMsg("sys", "chat", m.text || "");
        } catch (e) {
          console.error("chat handler error", e);
        }
      });

      // ---------- Move input ----------
      board.enableMoveInput((event) => {
        if (!currentRoom) return false;
        if (mode !== "matched") return false;
        if (!(myRole === "white" || myRole === "black")) return false;

        if (event.type === INPUT_EVENT_TYPE.moveInputStarted) {
          return canMoveNow();
        }

        if (event.type === INPUT_EVENT_TYPE.validateMoveInput) {
          if (!canMoveNow()) {
            sys("not your turn");
            board.setPosition(game.fen());
            return false;
          }

          const from = event.squareFrom;
          const to = event.squareTo;

          const mv = game.move({ from, to, promotion: "q" });
          if (!mv) {
            sys("illegal move");
            board.setPosition(game.fen());
            return false;
          }

          board.setPosition(game.fen());
          requestEval(game.fen());

          socket.emit("move", { move: { from, to, promotion: "q" }, fen: game.fen(), pgn: game.pgn() });
          return true;
        }

        return true;
      });

      // ---------- Buttons ----------
      playOnlineBtn.onclick = () => {
        sys("Play Online clicked");
        clearSession();
        setMode("searching");
        socket.emit("queue:join");
      };

      cancelBtn.onclick = () => {
        sys("Cancel clicked");
        socket.emit("queue:cancel");
        clearSession();
        setMode("idle");
      };

      createBtn.onclick = () => {
        sys("Create clicked");
        socket.emit("queue:cancel");
        socket.emit("room:create");
      };

      joinBtn.onclick = () => {
        const code = (joinInput.value || "").trim().toUpperCase();
        if (!code) return;
        sys("Join clicked: " + code);
        socket.emit("queue:cancel");
        socket.emit("room:join", { room: code });
      };

      restartBtn.onclick = () => {
        resetLocalGame();
        sys("restarted (local)");
      };

      copyBtn.onclick = async () => {
        const u = new URL(location.href);
        if (currentRoom) u.searchParams.set("room", currentRoom);
        await navigator.clipboard.writeText(u.toString());
        sys("room link copied");
      };

      function sendChat() {
        const t = (chatInput.value || "").trim();
        if (!t) return;
        socket.emit("chat:send", { text: t });
        chatInput.value = "";
      }

      sendBtn.onclick = sendChat;
      chatInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendChat(); });

      // auto-join from URL
      const roomParam = new URL(location.href).searchParams.get("room");
      if (roomParam) {
        const code = roomParam.trim().toUpperCase();
        sys("auto-join: " + code);
        socket.emit("room:join", { room: code });
      }

      // init UI
      setMode("idle");
      updateTopPills(0);
      resetLocalGame();
      sys("ready");
    </script>
  </body>
</html>

