<script src="/socket.io/socket.io.js"></script>
<script type="module">
  import { COLOR, Chessboard, FEN, INPUT_EVENT_TYPE } from "https://unpkg.com/cm-chessboard@8.7.8/src/Chessboard.js";

  // ---------- Socket ----------
  let socket = null;

  function connectSocket() {
    if (socket) return socket;

    socket = io({
      transports: ["polling", "websocket"],
      reconnection: true,
      reconnectionAttempts: Infinity,
      reconnectionDelay: 800,
      timeout: 10000,
    });

    socket.on("connect", () => sysLocal("connected"));
    socket.on("disconnect", (r) => sysLocal(`disconnected`));
    socket.on("connect_error", (e) => {
      console.error(e);
      sysLocal(`socket error`);
    });

    // ---- server events ----
    socket.on("status", (m) => sysLocal(m.msg));
    socket.on("room:created", (m) => sysLocal(`room ${m.room} created`));

    socket.on("room:joined", (m) => {
      currentRoom = m.room;
      myRole = m.role === "w" ? "white" : "black";
      roomEl.textContent = m.room;
      roleEl.textContent = myRole;
      playersEl.textContent = m.players;
      setOrientationForRole();
      restartBtn.disabled = false;
    });

    socket.on("room:update", (m) => {
      playersEl.textContent = m.players;
    });

    socket.on("game:start", () => {
      sysLocal("game started");
    });

    socket.on("move", ({ fen }) => {
      currentFen = fen;
      board.setPosition(fen);
    });

    socket.on("chat", (m) => addMessage({
      kind: "chat",
      at: new Date().toTimeString().slice(0, 8),
      from: "opponent",
      text: m.text,
    }));

    return socket;
  }

  // ---------- UI helpers ----------
  const roomEl = document.getElementById("room");
  const roleEl = document.getElementById("role");
  const playersEl = document.getElementById("players");
  const playOnlineBtn = document.getElementById("playOnline");
  const createBtn = document.getElementById("create");
  const joinBtn = document.getElementById("join");
  const roomInput = document.getElementById("roomInput");
  const restartBtn = document.getElementById("restart");
  const feedEl = document.getElementById("feed");

  let currentRoom = null;
  let myRole = "spectator";
  let currentFen = FEN.start;

  function sysLocal(text) {
    addMessage({
      kind: "sys",
      at: new Date().toTimeString().slice(0, 8),
      text,
    });
  }

  function addMessage({ kind, at, from, text }) {
    const row = document.createElement("div");
    row.className = `msg ${kind === "sys" ? "sys" : ""}`;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = kind === "sys" ? `${at} · sys` : `${at} · ${from}`;

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;

    row.appendChild(meta);
    row.appendChild(bubble);
    feedEl.appendChild(row);
    feedEl.scrollTop = feedEl.scrollHeight;
  }

  // ---------- Chessboard ----------
  const board = new Chessboard(document.getElementById("board"), {
    position: FEN.start,
    assetsUrl: "/cm-assets/",
    responsive: true,
  });

  function setOrientationForRole() {
    board.setOrientation(myRole === "black" ? COLOR.black : COLOR.white);
  }

  board.enableMoveInput((event) => {
    if (!socket || !currentRoom) return false;

    if (event.type === INPUT_EVENT_TYPE.validateMoveInput) {
      socket.emit("move", {
        room: currentRoom,
        move: { from: event.squareFrom, to: event.squareTo, promotion: "q" },
        fen: board.getPosition(),
      });
      return true;
    }
    return true;
  });

  // ---------- Buttons ----------
  playOnlineBtn.onclick = () => {
    const s = connectSocket();
    s.emit("room:create");
  };

  createBtn.onclick = () => {
    const s = connectSocket();
    s.emit("room:create");
  };

  joinBtn.onclick = () => {
    const code = roomInput.value.trim().toUpperCase();
    if (!code) return;
    const s = connectSocket();
    s.emit("room:join", { room: code });
  };
</script>

