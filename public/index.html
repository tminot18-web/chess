<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Live Eval Chess</title>

    <!-- cm-chessboard CSS (your local copy) -->
    <link rel="stylesheet" href="/cm-assets/chessboard.css" />
    <link rel="icon" href="data:," />

    <style>
      :root {
        --bg0: #0b0f18;
        --bg1: #0e1424;
        --card: rgba(16, 22, 38, 0.78);
        --border: rgba(255, 255, 255, 0.1);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.6);
        --shadow: 0 22px 70px rgba(0, 0, 0, 0.45);

        --btn: rgba(255, 255, 255, 0.08);
        --btnHover: rgba(255, 255, 255, 0.12);
        --input: rgba(255, 255, 255, 0.1);
        --pill: rgba(255, 255, 255, 0.08);

        --accent: rgba(255, 0, 120, 0.45);
        --ok: rgba(80, 255, 160, 0.9);
        --bad: rgba(255, 90, 120, 0.95);
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background:
          radial-gradient(1100px 800px at 20% 20%, rgba(255,255,255,0.06) 0%, transparent 55%),
          radial-gradient(900px 700px at 80% 30%, rgba(255,0,120,0.08) 0%, transparent 60%),
          radial-gradient(900px 700px at 60% 90%, rgba(0,160,255,0.10) 0%, transparent 62%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        color: var(--text);
      }

      .wrap {
        display: flex;
        gap: 28px;
        align-items: flex-start;
        justify-content: center;
        padding: 22px;
        width: min(1120px, 100%);
      }

      #board {
        width: 520px;
        height: 520px;
        flex: 0 0 520px;
        min-width: 520px;
        min-height: 520px;
        border-radius: 18px;
        overflow: hidden;
        background: #fff;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.08);
        position: relative;
      }

      /* visible even if JS dies */
      .boardFallback {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        color: rgba(0,0,0,0.6);
        font-weight: 800;
        letter-spacing: -0.02em;
        pointer-events: none;
      }

      .side {
        width: 460px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 14px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
      }

      .titleRow {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 12px;
      }

      .title {
        font-size: 16px;
        font-weight: 950;
        letter-spacing: -0.01em;
      }

      .sub {
        color: var(--muted);
        font-size: 13px;
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .pill {
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--pill);
        font-size: 13px;
      }

      button {
        padding: 12px 14px;
        font-size: 15px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--btn);
        cursor: pointer;
        font-weight: 800;
        color: var(--text);
      }
      button:hover { background: var(--btnHover); }
      button:disabled { opacity: 0.5; cursor: not-allowed; }

      input {
        padding: 10px 12px;
        font-size: 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        width: 170px;
        text-transform: uppercase;
        background: var(--input);
        color: var(--text);
        outline: none;
      }
      input::placeholder { color: rgba(255,255,255,0.45); }

      .feed {
        height: 260px;
        overflow: auto;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        padding: 10px;
      }

      .msg {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 10px;
        padding: 8px 8px;
        border-radius: 12px;
      }
      .msg + .msg { margin-top: 6px; }

      .meta {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 11px;
        color: rgba(255,255,255,0.55);
        white-space: nowrap;
      }

      .bubble {
        font-size: 13px;
        line-height: 1.35;
        white-space: pre-wrap;
        word-break: break-word;
        color: rgba(255,255,255,0.92);
      }

      .sys .bubble { color: rgba(255,255,255,0.78); }
      .err .bubble { color: var(--bad); font-weight: 800; }
      .ok .bubble { color: var(--ok); font-weight: 800; }

      .chatRow {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        margin-top: 10px;
      }

      .chatInput {
        padding: 10px 12px;
        font-size: 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.08);
        color: var(--text);
        outline: none;
        width: 100%;
        text-transform: none;
      }

      @media (max-width: 960px) {
        .wrap { flex-direction: column; align-items: center; }
        #board {
          width: min(92vw, 520px);
          height: min(92vw, 520px);
          flex: 0 0 auto;
          min-width: 0;
          min-height: 0;
        }
        .side { width: min(92vw, 640px); }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div id="board">
        <div class="boardFallback">loading…</div>
      </div>

      <div class="side">
        <div class="card">
          <div class="titleRow">
            <div>
              <div class="title">Live Eval Chess</div>
              <div class="sub">Multiplayer MVP (no hints, no undo)</div>
            </div>
          </div>

          <div style="height: 10px"></div>

          <div class="row">
            <span class="pill">Room <b id="room">—</b></span>
            <span class="pill">Role <b id="role">—</b></span>
            <span class="pill">Players <b id="players">0</b></span>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <button id="playOnline">Play Online</button>
            <button id="restart" disabled>Restart</button>
          </div>

          <div style="height: 10px"></div>

          <div class="row">
            <input id="roomInput" placeholder="ROOM CODE" maxlength="10" />
            <button id="join">Join</button>
            <button id="create">Create</button>
            <button id="copy" disabled>Copy Link</button>
          </div>
        </div>

        <div class="card">
          <div class="feed" id="feed"></div>

          <div class="chatRow">
            <input id="chatInput" class="chatInput" placeholder="type… (enter to send)" />
            <button id="sendChat">Send</button>
          </div>

          <div class="sub" style="margin-top: 10px">
            If you see an error message here, paste it to me and we’ll fix it instantly.
          </div>
        </div>
      </div>
    </div>

    <!-- MUST be served by your Express server (matches server Socket.IO version) -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- chess.js for legality + FEN -->
    <script src="https://cdn.jsdelivr.net/npm/chess.js@0.10.3/chess.min.js"></script>

    <script type="module">
      import { COLOR, Chessboard, FEN, INPUT_EVENT_TYPE } from "https://unpkg.com/cm-chessboard@8.7.8/src/Chessboard.js";

      const roomEl = document.getElementById("room");
      const roleEl = document.getElementById("role");
      const playersEl = document.getElementById("players");

      const playOnlineBtn = document.getElementById("playOnline");
      const restartBtn = document.getElementById("restart");
      const createBtn = document.getElementById("create");
      const joinBtn = document.getElementById("join");
      const copyBtn = document.getElementById("copy");
      const roomInput = document.getElementById("roomInput");

      const feedEl = document.getElementById("feed");
      const chatInput = document.getElementById("chatInput");
      const sendChatBtn = document.getElementById("sendChat");

      function addMessage({ kind = "sys", at, from, text }) {
        const row = document.createElement("div");
        row.className = `msg ${kind}`;

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent =
          kind === "chat"
            ? `${at} · ${from}`
            : `${at} · sys`;

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text;

        row.appendChild(meta);
        row.appendChild(bubble);
        feedEl.appendChild(row);
        feedEl.scrollTop = feedEl.scrollHeight;
      }

      function ts() {
        return new Date().toTimeString().slice(0, 8);
      }

      function sys(text) {
        addMessage({ kind: "sys", at: ts(), text });
      }
      function ok(text) {
        addMessage({ kind: "ok", at: ts(), text });
      }
      function err(text) {
        addMessage({ kind: "err", at: ts(), text });
      }

      // If anything crashes, print it IN the feed instead of blank screen.
      window.addEventListener("error", (e) => {
        err(`JS error: ${e.message || e.error || "unknown"}`);
      });
      window.addEventListener("unhandledrejection", (e) => {
        err(`Promise error: ${e.reason?.message || e.reason || "unknown"}`);
      });

      // Make sure socket.io client actually exists
      if (typeof io === "undefined") {
        err("Socket.IO client not loaded. /socket.io/socket.io.js failed to load.");
        throw new Error("io is undefined");
      }

      // Chess + board
      const game = new Chess();
      let currentRoom = null;
      let myRole = "spectator"; // white | black | spectator

      const board = new Chessboard(document.getElementById("board"), {
        position: FEN.start,
        responsive: true,
        assetsUrl: "/cm-assets/",
        orientation: COLOR.white,
      });

      // remove fallback once board exists
      const fb = document.querySelector(".boardFallback");
      if (fb) fb.remove();

      function setOrientation() {
        board.setOrientation(myRole === "black" ? COLOR.black : COLOR.white);
      }

      function updateUi() {
        roomEl.textContent = currentRoom || "—";
        roleEl.textContent = myRole || "—";
        restartBtn.disabled = !(myRole === "white" || myRole === "black");
        copyBtn.disabled = !currentRoom;
      }

      function resetGameLocal() {
        game.reset();
        board.setPosition(game.fen());
      }

      // Socket connection (ONE socket per page)
      const socket = io({
        transports: ["polling", "websocket"],
        reconnection: true,
        reconnectionAttempts: Infinity,
        reconnectionDelay: 800,
        timeout: 10000,
      });

      socket.on("connect", () => ok(`connected (${socket.id})`));
      socket.on("connect_error", (e) => {
        console.error("connect_error", e);
        err(`connect_error: ${e?.message || e || "unknown"}`);
      });
      socket.on("disconnect", (reason) => sys(`disconnected: ${reason}`));

      // Server events (match your CommonJS server.js)
      socket.on("status", (m) => sys(m?.msg || "status"));
      socket.on("room:created", (m) => {
        sys(`room created: ${m.room}`);
      });

      socket.on("room:joined", (m) => {
        currentRoom = m.room;
        myRole = m.role === "w" ? "white" : "black";
        playersEl.textContent = m.players ?? "—";
        setOrientation();
        resetGameLocal();
        updateUi();

        // persist room in URL
        const u = new URL(location.href);
        u.searchParams.set("room", currentRoom);
        history.replaceState({}, "", u);

        ok(`joined ${currentRoom} as ${myRole}`);
      });

      socket.on("room:update", (m) => {
        playersEl.textContent = m.players ?? playersEl.textContent;
      });

      socket.on("game:start", () => {
        ok("game started");
      });

      // Opponent move relay (your server sends { move, fen, pgn })
      socket.on("move", ({ move, fen }) => {
        if (!fen) return;
        game.load(fen);
        board.setPosition(game.fen());
        sys(`opponent moved`);
      });

      socket.on("chat", (m) => {
        addMessage({
          kind: "chat",
          at: ts(),
          from: m.from === socket.id ? "you" : "opponent",
          text: m.text || "",
        });
      });

      // Input handling
      function canMove() {
        const turn = game.turn(); // 'w' or 'b'
        if (myRole === "white") return turn === "w";
        if (myRole === "black") return turn === "b";
        return false;
      }

      board.enableMoveInput((event) => {
        if (!(myRole === "white" || myRole === "black")) return false;
        if (!currentRoom) return false;

        if (event.type === INPUT_EVENT_TYPE.moveInputStarted) {
          return canMove();
        }

        if (event.type === INPUT_EVENT_TYPE.validateMoveInput) {
          if (!canMove()) {
            sys("not your turn");
            board.setPosition(game.fen());
            return false;
          }

          const from = event.squareFrom;
          const to = event.squareTo;

          const mv = game.move({ from, to, promotion: "q" });
          if (!mv) {
            sys("illegal move");
            board.setPosition(game.fen());
            return false;
          }

          board.setPosition(game.fen());

          socket.emit("move", {
            room: currentRoom,
            move: { from, to, promotion: "q" },
            fen: game.fen(),
            pgn: game.pgn(),
          });

          return true;
        }

        return true;
      });

      // Buttons
      playOnlineBtn.onclick = () => {
        sys("creating room…");
        socket.emit("room:create");
      };

      createBtn.onclick = () => {
        sys("creating room…");
        socket.emit("room:create");
      };

      joinBtn.onclick = () => {
        const code = roomInput.value.trim().toUpperCase();
        if (!code) return;
        sys(`joining ${code}…`);
        socket.emit("room:join", { room: code });
      };

      restartBtn.onclick = () => {
        resetGameLocal();
        sys("restarted locally (MVP)");
      };

      copyBtn.onclick = async () => {
        const u = new URL(location.href);
        if (currentRoom) u.searchParams.set("room", currentRoom);
        await navigator.clipboard.writeText(u.toString());
        ok("room link copied");
      };

      function sendChat() {
        const t = (chatInput.value || "").trim();
        if (!t) return;
        if (!currentRoom) {
          sys("join a room first");
          return;
        }
        socket.emit("chat", { room: currentRoom, text: t });
        chatInput.value = "";
      }

      sendChatBtn.onclick = sendChat;
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendChat();
        }
      });

      // Auto-join room from URL
      const roomParam = new URL(location.href).searchParams.get("room");
      if (roomParam) {
        const code = roomParam.trim().toUpperCase();
        sys(`joining ${code}…`);
        socket.emit("room:join", { room: code });
      }

      updateUi();
      sys("ready");
    </script>
  </body>
</html>

